@page "/"
@using AirWave.Client.Services
@using AirWave.Client.Components.UI
@inject AqiService AqiService
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Dashboard | Giám sát chất lượng không khí</PageTitle>

<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Dashboard Chất lượng không khí</h1>
        <p class="text-gray-600 mt-1">Dữ liệu được cập nhật theo thời gian thực từ cảm biến.</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-1 flex flex-col gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <h2 class="text-lg font-semibold text-gray-600 mb-4">Chỉ số AQI hiện tại</h2>
                <RadialGauge Value="@latestReading?.AqiValue" Label="@GetVietnameseLevel()" Height="280" MaxValue="300" />
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <h2 class="text-lg font-semibold text-gray-600 mb-4">Trạng thái hệ thống</h2>
                <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 rounded-full @(isConnected ? "bg-green-500" : "bg-yellow-400 animate-pulse")"></div>
                    <span class="text-gray-700 font-medium">@(isConnected ? "Đã kết nối thời gian thực" : "Đang tải dữ liệu...")</span>
                </div>
                <p class="text-sm text-gray-500 mt-2">Hiển thị trạng thái kết nối thời gian thực qua API.</p>
            </div>
        </div>

        <div class="lg:col-span-2 flex flex-col gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-6">
                <h2 class="text-lg font-semibold text-gray-600">Lịch sử đo lường</h2>
                <div class="flex flex-col sm:flex-row gap-2 items-end">
                    <DatePicker @bind-SelectedDate="startDate" Placeholder="Từ ngày..." ContainerClass="relative w-full sm:w-64" />
                    <span class="text-gray-500 hidden sm:block self-center">-</span>
                    <DatePicker @bind-SelectedDate="endDate" Placeholder="Đến ngày..." ContainerClass="relative w-full sm:w-64" />
                    <button @onclick="FilterData" class="inline-flex items-center justify-center w-full sm:w-auto rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-slate-900 text-slate-50 hover:bg-slate-800 active:bg-slate-950 h-10 px-6 py-2 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                        </svg>
                        Lọc dữ liệu
                    </button>
                </div>
            </div>
            
            <div class="rounded-md border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thời gian</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chỉ số AQI</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mức độ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        @if (aqiData == null)
                        {
                            <tr><td colspan="3" class="text-center p-8 text-gray-500">Đang tải dữ liệu lịch sử...</td></tr>
                        }
                        else if (!pagedData.Any())
                        {
                            <tr><td colspan="3" class="text-center p-8 text-gray-500">Không có dữ liệu phù hợp.</td></tr>
                        }
                        else
                        {
                            @foreach (var item in pagedData)
                            {
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">@ToVietnamTime(item.Timestamp).ToString("dd/MM/yyyy HH:mm:ss")</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">@item.AqiValue</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full text-white @GetBadgeClass(item.AqiValue)">
                                            @GetVietnameseLevel(item.AqiValue)
                                        </span>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            @if (aqiData != null && aqiData.Any())
            {
                <div class="mt-4 border-t border-gray-200 bg-white px-4 py-3">
                    <Pagination 
                        @bind-CurrentPage="currentPage" 
                        TotalPages="totalPages"
                        InfoText="@($"Hiển thị {(currentPage - 1) * pageSize + 1} đến {Math.Min(currentPage * pageSize, totalItems)} trong tổng số {totalItems} kết quả")" />
                </div>
            }
        </div>
        </div>
    </div>
</div>

@code {
    private List<AqiDataDto>? aqiData;
    private AqiDataDto? latestReading;
    private DateTime? startDate;
    private DateTime? endDate;
    private PeriodicTimer? periodicTimer;
    private bool isConnected = false;
    private CancellationTokenSource? cts;
    
    private static readonly TimeZoneInfo VietnamTimeZone = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time");
    
    private int currentPage = 1;
    private int pageSize = 5;
    private int totalItems => aqiData?.Count ?? 0;
    private int totalPages => (int)Math.Ceiling(totalItems / (double)pageSize);
    private List<AqiDataDto> pagedData => aqiData?.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList() ?? new List<AqiDataDto>();

    protected override async Task OnInitializedAsync()
    {
        await LoadAllData();
        isConnected = true;
        
        cts = new CancellationTokenSource();
        periodicTimer = new PeriodicTimer(TimeSpan.FromSeconds(20));
        
        _ = Task.Run(async () =>
        {
            while (await periodicTimer.WaitForNextTickAsync(cts.Token))
            {
                await LoadLatestReading();
                await LoadHistoryData();
                await InvokeAsync(StateHasChanged);
            }
        }, cts.Token);
    }

    private async Task LoadAllData()
    {
        startDate = null;
        endDate = null;
        aqiData = await AqiService.GetAllAsync();
        currentPage = 1;
        await LoadLatestReading();
    }

    private async Task LoadLatestReading()
    {
        latestReading = await AqiService.GetLatestAsync();
    }

    private async Task LoadHistoryData()
    {
        if (startDate.HasValue || endDate.HasValue)
        {
            aqiData = await AqiService.GetFilteredAsync(startDate, endDate);
        }
        else
        {
            aqiData = await AqiService.GetAllAsync();
        }
    }

    private async Task FilterData()
    {
        if (startDate.HasValue || endDate.HasValue)
        {
            aqiData = await AqiService.GetFilteredAsync(startDate, endDate);
        }
        else
        {
            await LoadAllData();
        }
        currentPage = 1;
    }

    private string GetVietnameseLevel(int? aqi = null)
    {
        var value = aqi ?? latestReading?.AqiValue ?? 0;
        if (value <= 50) return "Tốt";
        if (value <= 100) return "Trung bình";
        if (value <= 150) return "Kém";
        return "Nguy hiểm";
    }

    private string GetBadgeClass(int aqi)
    {
        return aqi switch
        {
            <= 50 => "bg-green-500",
            <= 100 => "bg-yellow-400",
            <= 150 => "bg-orange-500",
            _ => "bg-red-600"
        };
    }

    private DateTime ToVietnamTime(DateTime utcTime)
    {
        // Assume database stores UTC, convert to Vietnam time for display
        if (utcTime.Kind == DateTimeKind.Unspecified)
        {
            // Treat unspecified as UTC
            utcTime = DateTime.SpecifyKind(utcTime, DateTimeKind.Utc);
        }
        return TimeZoneInfo.ConvertTimeFromUtc(utcTime, VietnamTimeZone);
    }

    public void Dispose()
    {
        cts?.Cancel();
        cts?.Dispose();
        periodicTimer?.Dispose();
    }
}
